name: Java CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * 1'  # –ö–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 2:00 AM

env:
  JAVA_VERSION: '17'
  MAVEN_VERSION: '3.9.6'
  PROJECT_NAME: 'url-shortener'
  REPORT_DIR: 'reports'

jobs:
  # Job 1: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
  build:
    name: üèóÔ∏è Build
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    
    - name: ‚öôÔ∏è Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        cache: 'maven'
    
    - name: üîç Validate pom.xml
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ pom.xml..."
        mvn help:effective-pom -q
        echo "‚úÖ pom.xml –≤–∞–ª–∏–¥–µ–Ω"
    
    - name: üì¶ Build with Maven
      run: |
        echo "üèóÔ∏è –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É –ø—Ä–æ–µ–∫—Ç–∞..."
        mvn clean compile -DskipTests
        echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
    
    - name: üìä Generate build report
      run: |
        echo "üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –æ —Å–±–æ—Ä–∫–µ..."
        mkdir -p ${{ env.REPORT_DIR }}
        mvn dependency:tree -DoutputFile=${{ env.REPORT_DIR }}/dependency-tree.txt
        echo "‚úÖ –û—Ç—á–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"
    
    - name: üíæ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          target/classes/
          ${{ env.REPORT_DIR }}/dependency-tree.txt
        retention-days: 7

  # Job 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  test:
    name: üß™ Test
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
    
    - name: ‚öôÔ∏è Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        cache: 'maven'
    
    - name: üß™ Run unit tests
      run: |
        echo "üß™ –ó–∞–ø—É—Å–∫ —é–Ω–∏—Ç-—Ç–µ—Å—Ç–æ–≤..."
        mvn test
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
        if [ -f "target/surefire-reports/TEST-com.urlshortener.test.UniqueShortCodesTest.xml" ]; then
          echo "‚úÖ UniqueShortCodesTest –≤—ã–ø–æ–ª–Ω–µ–Ω"
        fi
        if [ -f "target/surefire-reports/TEST-com.urlshortener.test.ClickLimitTest.xml" ]; then
          echo "‚úÖ ClickLimitTest –≤—ã–ø–æ–ª–Ω–µ–Ω"
        fi
        if [ -f "target/surefire-reports/TEST-com.urlshortener.test.ExpirationCleanupTest.xml" ]; then
          echo "‚úÖ ExpirationCleanupTest –≤—ã–ø–æ–ª–Ω–µ–Ω"
        fi
        if [ -f "target/surefire-reports/TEST-com.urlshortener.test.UserNotificationTest.xml" ]; then
          echo "‚úÖ UserNotificationTest –≤—ã–ø–æ–ª–Ω–µ–Ω"
        fi

  # Job 3: –õ–∏–Ω—Ç–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ (SBOM)
  lint-and-analyze:
    name: üîç Lint & Analyze (SBOM)
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
    
    - name: ‚öôÔ∏è Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        cache: 'maven'
    
    - name: üìã Checkstyle - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∫–æ–¥–∞
      run: |
        echo "üìã –ó–∞–ø—É—Å–∫ Checkstyle..."
        mvn checkstyle:check
        echo "‚úÖ Checkstyle –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    
    - name: üîé SpotBugs - –ü–æ–∏—Å–∫ –±–∞–≥–æ–≤
      run: |
        echo "üîé –ó–∞–ø—É—Å–∫ SpotBugs..."
        mvn spotbugs:check
        echo "‚úÖ SpotBugs –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    
    - name: üìù PMD - –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞
      run: |
        echo "üìù –ó–∞–ø—É—Å–∫ PMD..."
        mvn pmd:check
        echo "‚úÖ PMD –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω"
    
    - name: üõ°Ô∏è OWASP Dependency Check - –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
      run: |
        echo "üõ°Ô∏è –ó–∞–ø—É—Å–∫ OWASP Dependency Check..."
        mvn org.owasp:dependency-check-maven:check
        echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    
    - name: üì¶ CycloneDX SBOM - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SBOM
      run: |
        echo "üì¶ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SBOM (Software Bill of Materials)..."
        mvn org.cyclonedx:cyclonedx-maven-plugin:makeAggregateBom
        echo "‚úÖ SBOM —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"
        
        # –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö
        if [ -f "target/bom.xml" ]; then
          COMPONENTS=$(grep -c '<component' target/bom.xml || echo "0")
          VULNERABILITIES=$(grep -c 'vulnerability' target/bom.xml || echo "0")
          echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ SBOM:"
          echo "   ‚Ä¢ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤: $COMPONENTS"
          echo "   ‚Ä¢ –£—è–∑–≤–∏–º–æ—Å—Ç–µ–π: $VULNERABILITIES"
        fi

